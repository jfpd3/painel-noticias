<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel — Cripto & Finanças</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon-192.png">
  <style>
    :root{
      --bg:#0b1020; --card:#121a2f; --text:#e9efff; --muted:#8fa3c9; --border:#203055; --accent:#5aa2ff;
      --impact-high:#ff4646; --impact-low:#ffc542;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:14px 16px}
    header{position:sticky;top:0;background:rgba(11,16,32,.75);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border);z-index:5}
    h1{font-size:20px;margin:0;display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#0f1730;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .chip.active{background:var(--accent);color:#0b1020;border-color:transparent}
    .toolbar{margin-top:10px}
    .pill{background:#0f1730;color:var(--muted);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    main{display:grid;grid-template-columns:1fr 330px;gap:16px;margin-top:10px}
    @media (max-width:980px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .news-card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
    .news-card h3{margin:8px 0 6px 0;font-size:17px}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .links{display:flex;gap:12px;align-items:center;margin-top:6px}
    .links a{color:var(--accent);text-decoration:none}
    .impact-dot{position:absolute;top:12px;right:12px;width:12px;height:12px;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.35);border:2px solid rgba(0,0,0,.25)}
    .impact-high{background:var(--impact-high)}
    .impact-low{background:var(--impact-low)}
    .aside{display:flex;flex-direction:column;gap:12px}
    .a2hs{display:none;margin-top:16px}
    .fabbar{display:none}
    footer{color:var(--muted);text-align:center;margin:16px 0}
    small.kbd{padding:1px 6px;border:1px solid var(--border);border-radius:6px;background:#0f1730}
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="row" style="justify-content:space-between">
      <h1>
        Painel — Cripto & Finanças
        <span class="pill" id="countLabel">0 itens</span>
      </h1>
      <div class="muted">Feed: <span id="feedUrlLabel">/noticias.json</span> — <span id="statusLabel">a carregar…</span></div>
    </div>

    <div class="toolbar">
      <div class="toolbar-row">
        <div class="chips" id="rangeChips">
          <!-- NÃO deixes 'active' no HTML; o JS trata disso -->
          <button class="chip" data-range="24">24h</button>
          <button class="chip" data-range="48">48h</button>
          <button class="chip" data-range="168">7d</button>
          <button class="chip" data-range="0">Todas</button>
        </div>
        <div class="chips" id="catChips"></div>
        <label class="row" style="margin-left:auto;gap:6px">
          <input id="hideRead" type="checkbox"> <span class="muted">Esconder lidas</span>
        </label>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <main>
    <section>
      <div id="newsList"></div>
    </section>

    <aside class="aside">
      <div class="card">
        <strong>Hoje: 3 pontos de atenção</strong>
        <ol id="attentionList" style="margin:8px 0 0 18px;padding:0"></ol>
      </div>

      <section class="a2hs card" id="a2hsBlock">
        <div class="row" style="align-items:center;justify-content:space-between;gap:10px">
          <div>
            <strong>Adicionar ao ecrã principal</strong>
            <p class="muted" style="margin:6px 0 0">Abre como app, sem barra do browser.</p>
          </div>
          <button class="chip" id="a2hsBtn">Adicionar</button>
        </div>
      </section>
    </aside>
  </main>

  <footer>
    <small class="muted">Mobile PWA: “Adicionar ao ecrã principal” no fundo da página · Auto-refresh 5min.</small>
  </footer>
</div>

<script>
  // ======= CONFIG =======
  // Se o teu site estiver noutro caminho, ajusta aqui:
  const FEED_URL = '/painel-noticias/noticias.json'; // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  const AUTO_REFRESH_MS = 5 * 60 * 1000;
  const CATEGORIES = ['All','Crypto','US Macro','Regulação','Earnings','Markets'];

  // Permite override via ?feed=https://...
  const qsFeed = new URLSearchParams(location.search).get('feed');
  const RESOLVED_FEED_URL = qsFeed || FEED_URL;

  // ======= DOM =======
  const newsList = document.getElementById('newsList');
  const attentionList = document.getElementById('attentionList');
  const statusLabel = document.getElementById('statusLabel');
  const feedUrlLabel = document.getElementById('feedUrlLabel');
  const countLabel = document.getElementById('countLabel');
  const rangeChips = document.getElementById('rangeChips');
  const catChips   = document.getElementById('catChips');
  const hideRead   = document.getElementById('hideRead');
  const a2hsBlock  = document.getElementById('a2hsBlock');
  const a2hsBtn    = document.getElementById('a2hsBtn');

  feedUrlLabel.textContent = RESOLVED_FEED_URL;

  // ======= STATE =======
  let DATA   = { days: [] };
  let currentCategory = localStorage.getItem('pn_cat') || 'All';
  let hoursRange      = parseInt(localStorage.getItem('pn_range') || '24', 10);

  // “lidas”
  let readSet;
  try { readSet = new Set(JSON.parse(localStorage.getItem('pn_read') || '[]')); }
  catch { readSet = new Set(); }
  function saveReadSet(){ localStorage.setItem('pn_read', JSON.stringify([...readSet])); }
  function markRead(id, isRead){ if(isRead) readSet.add(id); else readSet.delete(id); saveReadSet(); }

  // ======= TOOLBAR (tempo + categorias) =======
  function updateToolbarState(){
    rangeChips.querySelectorAll('.chip').forEach(b=>{
      b.classList.toggle('active', parseInt(b.dataset.range,10) === hoursRange);
    });
    catChips.querySelectorAll('.chip').forEach(b=>{
      b.classList.toggle('active', b.dataset.cat === currentCategory);
    });
  }
  function setRange(r){
    hoursRange = parseInt(String(r), 10);
    localStorage.setItem('pn_range', String(hoursRange));
    updateToolbarState();
    renderAll();
  }
  function setCategory(cat){
    currentCategory = cat;
    localStorage.setItem('pn_cat', currentCategory);
    updateToolbarState();
    renderAll();
  }
  // constrói chips de categoria se não existirem
  if (!catChips.querySelector('.chip')) {
    catChips.innerHTML = CATEGORIES.map(c=>`<button class="chip" data-cat="${c}">${c}</button>`).join('');
  }
  // liga eventos
  rangeChips.querySelectorAll('.chip').forEach(b=>{
    b.addEventListener('click', ()=> setRange(b.dataset.range));
  });
  catChips.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    setCategory(btn.dataset.cat);
  });
  if (hideRead) hideRead.addEventListener('change', ()=> renderAll());
  updateToolbarState();

  // ======= UTILS =======
  function toTs(dayDate, timeStr){
    // dayDate: 'YYYY-MM-DD' ; timeStr: 'HH:MM'
    if(!dayDate) return 0;
    let h=0,m=0;
    if (timeStr && timeStr.includes(':')) {
      const [hh,mm] = timeStr.split(':');
      h = parseInt(hh||'0',10); m = parseInt(mm||'0',10);
    }
    const [Y,Mo,D] = dayDate.split('-').map(Number);
    return new Date(Y, (Mo-1), D, h, m, 0, 0).getTime();
  }

  function flattenWithin(hours){
    const out = [];
    const now = Date.now();
    const cutoff = hours > 0 ? (now - hours * 3600 * 1000) : 0;
    (DATA.days || []).forEach(day=>{
      (day.items || []).forEach(it=>{
        const ts = toTs(day.date, it.time);
        if (cutoff === 0 || (!isNaN(ts) && ts >= cutoff)) {
          out.push({ ...it, _ts: ts, _day: day.date });
        }
      });
    });
    out.sort((a,b)=> b._ts - a._ts);
    return out;
  }

  // ======= RENDER =======
  function renderAttention(){
    // usa o que vier no JSON para o dia corrente (primeiro da lista)
    attentionList.innerHTML = '';
    const day0 = (DATA.days||[])[0];
    const arr = (day0 && day0.attention_points) ? day0.attention_points.slice(0,3) : [];
    arr.forEach(t=>{
      const li=document.createElement('li'); li.textContent=t; attentionList.appendChild(li);
    });
  }

  function renderList(){
    const items = flattenWithin(hoursRange).filter(it=>{
      if (currentCategory !== 'All' && it.category !== currentCategory) return false;
      if (hideRead && hideRead.checked && readSet.has(it.id)) return false;
      return true;
    });

    newsList.innerHTML = '';
    items.forEach(it=>{
      const card = document.createElement('div');
      card.className = 'news-card';
      const dotClass = it.impact === 'high' ? 'impact-high' : (it.impact === 'low' ? 'impact-low' : '');
      const dot = dotClass ? `<span class="impact-dot ${dotClass}"></span>` : '';
      card.innerHTML = `
        ${dot}
        <div class="meta">
          <span>${it.time} • ${it._day||''}</span>
          <span class="chip">${it.category}</span>
          ${it.tags && it.tags.length ? it.tags.slice(0,3).map(t=>`<span class="pill">${t}</span>`).join('') : ''}
        </div>
        <h3>${it.title}</h3>
        ${it.summary ? `<p class="muted">${it.summary}</p>` : ''}
        <div class="links">
          <span class="muted">${it.source||''}</span>
          <a href="${it.url}" target="_blank" rel="noreferrer">Abrir fonte</a>
          <label class="row" style="gap:6px;margin-left:auto">
            <input type="checkbox" ${readSet.has(it.id)?'checked':''}
                   onchange="(function(el){ ${/* closure segura */''}
                     if(el.checked){ readSet.add('${it.id}'); } else { readSet.delete('${it.id}'); }
                     localStorage.setItem('pn_read', JSON.stringify(Array.from(readSet)));
                   })(this)">
            <span class="muted">Lida</span>
          </label>
        </div>
      `;
      newsList.appendChild(card);
    });

    countLabel.textContent = `${items.length} itens`;
  }

  function renderAll(){
    renderAttention();
    renderList();
  }

  // ======= FETCH + FALLBACK =======
  async function fetchFeed(){
    statusLabel.textContent = 'a carregar…';
    const u1 = RESOLVED_FEED_URL + '?_ts=' + Date.now();
    const u2 = 'https://raw.githubusercontent.com/jfpd3/painel-noticias/main/noticias.json?_ts=' + Date.now();

    const tries = [u1, u2];
    let json=null, lastErr=null;

    for (const url of tries){
      try{
        const res = await fetch(url, { cache:'reload', headers:{'Cache-Control':'no-cache'} });
        if(!res.ok) throw new Error('HTTP '+res.status+' em '+url);
        json = await res.json();
        break;
      }catch(e){ lastErr = e; }
    }

    if (json){
      DATA = json || { days:[] };
      renderAll();
      statusLabel.textContent = 'OK';
    } else {
      statusLabel.textContent = 'falhou';
      console.error('Falha a carregar noticias.json:', lastErr);
      newsList.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <strong>Erro a carregar o feed</strong>
        <p class="muted" style="margin-top:6px">${lastErr ? String(lastErr).replace(/</g,'&lt;') : 'erro desconhecido'}</p>
        <p class="muted">Testa abrir:
          <a href="${u1}" target="_blank" rel="noreferrer">${u1}</a><br/>
          <a href="${u2}" target="_blank" rel="noreferrer">${u2}</a>
        </p>
      `;
      newsList.appendChild(div);
    }
  }

  // ======= A2HS (Add to Home Screen) =======
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e; a2hsBlock.style.display='block';
  });
  a2hsBtn.addEventListener('click', async ()=>{
    if(!deferredPrompt){ alert('No iPhone: Partilhar → “Adicionar ao ecrã principal”.'); return; }
    deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; a2hsBlock.style.display='none';
  });

  // ======= START =======
  fetchFeed(); setInterval(fetchFeed, AUTO_REFRESH_MS);
</script>

<script>
// SW: permitir desligar com ?nosw=1
const NOSW = new URLSearchParams(location.search).get('nosw') === '1';
if ('serviceWorker' in navigator) {
  if (NOSW) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  } else {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
}
</script>
</body>
</html>
