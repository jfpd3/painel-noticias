<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel — Cripto & Finanças</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon-192.png">
  <style>
    
/* bolinhas dos cards*/
/*    :root{
/*    --impact-high: #ff4444;   /* vermelho */
 /*   --impact-low:  #ffc542;   /* amarelo  */
 /* } 

  /* === Bolinhas de impacto - versão premium === */
/* === Bolinhas de impacto - versão premium === */
.news-card { position: relative; }

.impact-dot {
  position: absolute;
  top: 10px; right: 10px;
  width: 11px; height: 11px;
  border-radius: 50%;
  display: inline-block;
  opacity: 0.95;
  box-shadow: 0 0 0 2px rgba(255,255,255,0.15), 0 1px 6px rgba(0,0,0,0.45);
  transition: transform .2s ease, box-shadow .2s ease;
}
.impact-dot:hover {
  transform: scale(1.25);
  box-shadow: 0 0 10px rgba(255,255,255,0.25);
}

/* Alto impacto (vermelho premium) */
.impact-red {
  background: radial-gradient(circle at 30% 30%, #ff5555 0%, #b70000 90%);
  border: 1px solid rgba(255,120,120,0.8);
}
/* Médio (âmbar premium) */
.impact-amber {
  background: radial-gradient(circle at 30% 30%, #ffdb66 0%, #c89b00 90%);
  border: 1px solid rgba(255,220,130,0.7);
}
/* Baixo (cinza premium) */
.impact-gray {
  background: radial-gradient(circle at 30% 30%, #b3b3b3 0%, #505050 90%);
  border: 1px solid rgba(200,200,200,0.4);
}
    
    :root{
      --bg:#0b1020; --card:#121a2f; --text:#e9efff; --muted:#8fa3c9; --border:#203055; --accent:#5aa2ff;
      --impact-high:#ff4646; --impact-low:#ffc542;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:14px 16px}
    header{position:sticky;top:0;background:rgba(11,16,32,.75);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border);z-index:5}
    h1{font-size:20px;margin:0;display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#0f1730;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .chip.active{background:var(--accent);color:#0b1020;border-color:transparent}
    .toolbar{margin-top:10px}
    .pill{background:#0f1730;color:var(--muted);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    main{display:grid;grid-template-columns:1fr 330px;gap:16px;margin-top:10px}
    @media (max-width:980px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .news-card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
    .news-card h3{margin:8px 0 6px 0;font-size:17px}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .links{display:flex;gap:12px;align-items:center;margin-top:6px}
    .links a{color:var(--accent);text-decoration:none}
    .impact-dot{position:absolute;top:12px;right:12px;width:12px;height:12px;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.35);border:2px solid rgba(0,0,0,.25)}
    .impact-high{background:var(--impact-high)}
    .impact-low{background:var(--impact-low)}
    .aside{display:flex;flex-direction:column;gap:12px}
    .a2hs{display:none;margin-top:16px}
    .fabbar{display:none}
    footer{color:var(--muted);text-align:center;margin:16px 0}
    small.kbd{padding:1px 6px;border:1px solid var(--border);border-radius:6px;background:#0f1730}


.impact-red   { background:#e53935; }   /* grande impacto */
.impact-amber { background:#f6c343; }   /* pouco impacto  */

    /* ===== Ajustes visuais dos botões ===== */

/* 1) Espaço horizontal entre o grupo de timeframes e o de categorias */
#rangeChips { margin-right: 14px; }

/* 2) Quando a linha quebrar, cria espaçamento vertical entre grupos */
.toolbar-row { display: flex; flex-wrap: wrap; gap: 10px 16px; }

/* 3) Em ecrãs estreitos, deixa as categorias irem para a linha seguinte a 100% */
@media (max-width: 820px){
  #catChips { flex: 1 1 100%; }
}

/* 4) Opcional: aumentar ligeiramente o conforto visual dos chips */
.chip { padding: 8px 14px; }

  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="row" style="justify-content:space-between">
      <h1>
        Painel — Cripto & Finanças
        <span class="pill" id="countLabel">0 itens</span>
      </h1>
      <div class="muted">Feed: <span id="feedUrlLabel">/noticias.json</span> — <span id="statusLabel">a carregar…</span></div>
    </div>

    <div class="toolbar">
      <div class="toolbar-row">
        <div class="chips" id="rangeChips">
          <!-- NÃO deixes 'active' no HTML; o JS trata disso -->
          <button class="chip" data-range="24">24h</button>
          <button class="chip" data-range="48">48h</button>
          <button class="chip" data-range="168">7d</button>
        </div>
        <div class="chips" id="catChips"></div>
        <label class="row" style="margin-left:auto;gap:6px">
          <input id="hideRead" type="checkbox"> <span class="muted">Esconder lidas</span>
        </label>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <main>
    <section>
      <div id="newsList"></div>
    </section>

    <aside class="aside">
      <div class="card">
        <strong>Hoje: 3 pontos de atenção</strong>
        <ol id="attentionList" style="margin:8px 0 0 18px;padding:0"></ol>
      </div>

      <section class="a2hs card" id="a2hsBlock">
        <div class="row" style="align-items:center;justify-content:space-between;gap:10px">
          <div>
            <strong>Adicionar ao ecrã principal</strong>
            <p class="muted" style="margin:6px 0 0">Abre como app, sem barra do browser.</p>
          </div>
          <button class="chip" id="a2hsBtn">Adicionar</button>
        </div>
      </section>
    </aside>
  </main>

  <footer>
    <small class="muted">Mobile PWA: “Adicionar ao ecrã principal” no fundo da página · Auto-refresh 5min.</small>
  </footer>
</div>

<script>
  // ======= CONFIG =======
  // Se o teu site estiver noutro caminho, ajusta aqui:
  const FEED_URL = '/painel-noticias/noticias.json'; // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  const AUTO_REFRESH_MS = 5 * 60 * 1000;
  const CATEGORIES = [
  { value: 'All',        label: 'Todas' },
  { value: 'Crypto',     label: 'Crypto' },
  { value: 'US Macro',   label: 'US Macro' },
  { value: 'Regulation', label: 'Regulação' },
  { value: 'Earnings',   label: 'Earnings' },
  { value: 'Markets',    label: 'Markets' },
];

  // Permite override via ?feed=https://...
  const qsFeed = new URLSearchParams(location.search).get('feed');
  const RESOLVED_FEED_URL = qsFeed || FEED_URL;

  // ======= DOM =======
  const newsList = document.getElementById('newsList');
  const attentionList = document.getElementById('attentionList');
  const statusLabel = document.getElementById('statusLabel');
  const feedUrlLabel = document.getElementById('feedUrlLabel');
  const countLabel = document.getElementById('countLabel');
  const rangeChips = document.getElementById('rangeChips');
  const catChips   = document.getElementById('catChips');
  const hideRead   = document.getElementById('hideRead');
  const a2hsBlock  = document.getElementById('a2hsBlock');
  const a2hsBtn    = document.getElementById('a2hsBtn');

  feedUrlLabel.textContent = RESOLVED_FEED_URL;

  // ======= STATE =======
  let DATA   = { days: [] };
  let currentCategory = localStorage.getItem('pn_cat') || 'All';
  let hoursRange      = parseInt(localStorage.getItem('pn_range') || '24', 10);
  // só permitimos 24/48/168; se houver 0 antigo, volta a 24
const VALID_RANGES = [24, 48, 168];
if (!VALID_RANGES.includes(hoursRange)) {
  hoursRange = 24;
  localStorage.setItem('pn_range', '24');
}

  // “lidas”
  let readSet;
  try { readSet = new Set(JSON.parse(localStorage.getItem('pn_read') || '[]')); }
  catch { readSet = new Set(); }
  function saveReadSet(){ localStorage.setItem('pn_read', JSON.stringify([...readSet])); }
  function markRead(id, isRead){ if(isRead) readSet.add(id); else readSet.delete(id); saveReadSet(); }

  // ======= TOOLBAR (tempo + categorias) =======
  function updateToolbarState(){
    rangeChips.querySelectorAll('.chip').forEach(b=>{
      b.classList.toggle('active', parseInt(b.dataset.range,10) === hoursRange);
    });
    catChips.querySelectorAll('.chip').forEach(b=>{
      b.classList.toggle('active', b.dataset.cat === currentCategory);
    });
  }
  function setRange(r){
    hoursRange = parseInt(String(r), 10);
    localStorage.setItem('pn_range', String(hoursRange));
    updateToolbarState();
    renderAll();
  }
  function setCategory(cat){
    currentCategory = cat;
    localStorage.setItem('pn_cat', currentCategory);
    updateToolbarState();
    renderAll();
  }
  // constrói chips de categoria com value/label
   if (!catChips.querySelector('.chip')) {
  catChips.innerHTML = CATEGORIES
    .map(c => `<button class="chip" data-cat="${c.value}">${c.label}</button>`)
    .join('');
}
  // liga eventos
  rangeChips.querySelectorAll('.chip').forEach(b=>{
    b.addEventListener('click', ()=> setRange(b.dataset.range));
  });
  catChips.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    setCategory(btn.dataset.cat);
  });
  if (hideRead) hideRead.addEventListener('change', ()=> renderAll());
  updateToolbarState();

  // ======= UTILS =======
  function toTs(dayDate, timeStr){
    // dayDate: 'YYYY-MM-DD' ; timeStr: 'HH:MM'
    if(!dayDate) return 0;
    let h=0,m=0;
    if (timeStr && timeStr.includes(':')) {
      const [hh,mm] = timeStr.split(':');
      h = parseInt(hh||'0',10); m = parseInt(mm||'0',10);
    }
    const [Y,Mo,D] = dayDate.split('-').map(Number);
    return new Date(Y, (Mo-1), D, h, m, 0, 0).getTime();
  }

  function flattenWithin(hours){
  const out = [];
  const cutoff = Date.now() - hours * 3600 * 1000;

  (DATA.days || []).forEach(day => {
    (day.items || []).forEach(it => {
      let ts;
      if (it.time_iso) {
        // usa o carimbo ISO (Lisboa) gerado pelo fetch — mais robusto em fusos horários
        ts = new Date(it.time_iso).getTime();
      } else {
        // fallback para compatibilidade antiga
        ts = toTs(day.date, it.time);
      }
      if (!isNaN(ts) && ts >= cutoff) {
        out.push({ ...it, _ts: ts, _day: day.date });
      }
    });
  });
  out.sort((a, b) => b._ts - a._ts);
  return out;
}
  // Devolve idade relativa do item, a partir do timestamp absoluto (_ts)
function formatAge(ts){
  if (!ts) return '';
  const diffMs = Date.now() - ts;
  const mins = Math.floor(diffMs / 60000);
  if (mins < 60) return `${Math.max(mins, 1)}min`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}hr`;
  const days = Math.floor(hours / 24);
  return `${days}d`;
}

  // ======= RENDER =======
  function renderAttention(){
    // usa o que vier no JSON para o dia corrente (primeiro da lista)
    attentionList.innerHTML = '';
    const day0 = (DATA.days||[])[0];
    const arr = (day0 && day0.attention_points) ? day0.attention_points.slice(0,3) : [];
    arr.forEach(t=>{
      const li=document.createElement('li'); li.textContent=t; attentionList.appendChild(li);
    });
  }

  function impactLevel(item){
  const cat = (item.category || '').toLowerCase();
  const t   = (item.title || '').toLowerCase();

  const hit = (arr) => arr.some(k => t.includes(k));

  // Alto impacto: macro/regulatório/earnings/markets com palavras “fortes”
  if (["us macro","regulation","earnings","markets"].includes(cat)){
    if (hit(["cpi","pce","payroll","jobs","unemployment","fed","fomc","rate",
             "cut","hike","sec","cftc","lawsuit","settlement","ban","halt",
             "chapter 11","bankruptcy","merger","acquisition","m&a","guidance",
             "beats","misses","downgrade","upgrade","record","plunge","surge"])) {
      return "high";
    }
  }

  // Alto impacto em cripto com eventos/regras relevantes
  if (cat === "crypto"){
    if (hit(["bitcoin","btc","ethereum","eth","etf","hack","exploit",
             "liquidation","outflow","inflow","ath","all-time high",
             "%", "dump", "pump", "halt"])) {
      return "high";
    }
  }

  // Caso contrário: baixo
  return "low";
}

function appendImpactDot(cardEl, item){
  const span = document.createElement('span');
  const lvl  = impactLevel(item);
  span.className = 'impact-dot ' + (lvl === 'high' ? 'impact-high' : 'impact-low');
  cardEl.appendChild(span);
}


  function renderList(){
    const items = flattenWithin(hoursRange).filter(it=>{
      if (currentCategory !== 'All' && it.category !== currentCategory) return false;
      if (hideRead && hideRead.checked && readSet.has(it.id)) return false;
      return true;
    });

    newsList.innerHTML = '';
    items.forEach(it=>{
      const card = document.createElement('div');
      card.className = 'news-card';
      const dotClass = it.impact === 'high' ? 'impact-high' : (it.impact === 'low' ? 'impact-low' : '');
      const dot = dotClass ? `<span class="impact-dot ${dotClass}"></span>` : '';
      const age = formatAge(it._ts);
      card.innerHTML = `
        ${dot}
        <div class="meta">
          <span>${age ? `(${age}) ` : ''}${it.time} • ${it._day||''}</span>
          <span class="chip">${it.category}</span>
          ${it.tags && it.tags.length ? it.tags.slice(0,3).map(t=>`<span class="pill">${t}</span>`).join('') : ''}
        </div>
        <h3>${it.title}</h3>
        ${it.summary ? `<p class="muted">${it.summary}</p>` : ''}
        <div class="links">
          <span class="muted">${it.source||''}</span>
          <a href="${it.url}" target="_blank" rel="noreferrer">Abrir fonte</a>
          <label class="row" style="gap:6px;margin-left:auto">
            <input type="checkbox" ${readSet.has(it.id)?'checked':''}
                   onchange="(function(el){ ${/* closure segura */''}
                     if(el.checked){ readSet.add('${it.id}'); } else { readSet.delete('${it.id}'); }
                     localStorage.setItem('pn_read', JSON.stringify(Array.from(readSet)));
                   })(this)">
            <span class="muted">Lida</span>
          </label>
        </div>
      `;
      newsList.appendChild(card);
    });

    countLabel.textContent = `${items.length} itens`;
  }

  
  function impactLevel(it){
  const t = ((it?.title||'') + ' ' + (it?.summary||'')).toLowerCase();
  // heurística simples: palavras “fortes” => alto impacto
  if (/\b(cpi|pce|payroll|jobs|fed|fomc|rate|hike|cut|sec|cftc|etf|halts|ban|probe|lawsuit|bankruptcy|default|surge|plunge|record)\b/.test(t)) return 'impact-high';
  if (/\b(btc|bitcoin|eth|ethereum|solana|binance|coinbase|dow|nasdaq|s&p|sp500|earnings|guidance)\b/.test(t)) return 'impact-low';
  return 'impact-low';
}
  
  function renderAll(){
    renderAttention();
    renderList();
    applyImpactDots();
  }

  // ======= FETCH + FALLBACK =======
  async function fetchFeed(){
    statusLabel.textContent = 'a carregar…';
    const u1 = RESOLVED_FEED_URL + '?_ts=' + Date.now();
    const u2 = 'https://raw.githubusercontent.com/jfpd3/painel-noticias/main/noticias.json?_ts=' + Date.now();

    const tries = [u1, u2];
    let json=null, lastErr=null;

    for (const url of tries){
      try{
        const res = await fetch(url, { cache:'reload', headers:{'Cache-Control':'no-cache'} });
        if(!res.ok) throw new Error('HTTP '+res.status+' em '+url);
        json = await res.json();
        break;
      }catch(e){ lastErr = e; }
    }

    if (json){
  DATA = json || { days:[] };
  statusLabel.textContent = 'OK';
  renderAll();              // já chama applyImpactDots()
} else {
  statusLabel.textContent = 'falhou';
  console.error('Falha a carregar noticias.json:', lastErr);
  newsList.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <strong>Erro a carregar o feed</strong>
    <p class="muted" style="margin-top:6px">${lastErr ? String(lastErr).replace(/</g,'&lt;') : 'erro desconhecido'}</p>
    <p class="muted">Testa abrir:
      <a href="${u1}" target="_blank" rel="noreferrer">${u1}</a><br/>
      <a href="${u2}" target="_blank" rel="noreferrer">${u2}</a>
    </p>
  `;
  newsList.appendChild(div);
}
  }

  function decorateImpactDots(){
  try{
    const host = document.getElementById('newsList') || document;
    const cards = host.querySelectorAll('.card, .news-card');
    cards.forEach(card=>{
      if (card.querySelector('.impact-dot')) return; // já tem
      // tenta obter título e resumo do cartão
      const title = card.querySelector('strong, h3, .title')?.textContent?.trim() || '';
      // escolhe o primeiro <p> “normal” como resumo
      let summary = '';
      const p = Array.from(card.querySelectorAll('p')).find(x=>!x.classList.contains('muted'));
      if (p) summary = p.textContent.trim();
      const it = { title, summary };
      const level = impactLevel(it); // 'impact-high' ou 'impact-low'
      const dot = document.createElement('span');
      dot.className = `impact-dot ${level}`;
      card.appendChild(dot);
    });
  }catch(e){ console.error('decorateImpactDots falhou:', e); }
}


  // ======= A2HS (Add to Home Screen) =======
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e; a2hsBlock.style.display='block';
  });
  a2hsBtn.addEventListener('click', async ()=>{
    if(!deferredPrompt){ alert('No iPhone: Partilhar → “Adicionar ao ecrã principal”.'); return; }
    deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; a2hsBlock.style.display='none';
  });

  // ======= START =======
  fetchFeed(); setInterval(fetchFeed, AUTO_REFRESH_MS);

  // Decide a cor do impacto com base na categoria, pills e título
function classifyImpact(card){
  const cat = (card.querySelector('.chip')?.textContent || '').trim().toLowerCase();
  const pills = [...card.querySelectorAll('.pill')].map(p=>p.textContent.trim().toLowerCase());
  const title = (card.querySelector('h3')?.textContent || '').toLowerCase();

  // Sinais de impacto ALTO (vermelho)
  const redByCat   = cat === 'us macro' || cat === 'regulation';
  const redByPill  = pills.some(p => ['btc','eth','sol'].includes(p));
  const redByTitle = /(cpi|pce|payrolls|jobs|inflation|sec|cftc|fed|fomc|ban|halt|tariff|default|treasury|yields|etf|collapse)/.test(title);

  // Sinais de impacto MÉDIO (âmbar)
  const amberByCat   = cat === 'earnings' || cat === 'markets';
  const amberByTitle = /(guidance|beats|misses|update|trend|report|futuros|volatility|drop|rise)/.test(title);

  if (redByCat || redByPill || redByTitle) return 'red';
  if (amberByCat || amberByTitle) return 'amber';
  return 'gray'; // resto é neutro
}


function applyImpactDots(){
  document.querySelectorAll('.news-card').forEach(card=>{
    // evita duplicar
    if (card.querySelector('.impact-dot')) return;

    const impact = classifyImpact(card); // 'red' | 'amber' | 'gray'
    const cls = impact === 'red' ? 'impact-red'
             : impact === 'amber' ? 'impact-amber'
             : 'impact-gray';

    const dot = document.createElement('span');
    dot.className = 'impact-dot ' + cls;
    dot.title = impact === 'red' ? 'Impacto alto'
             : impact === 'amber' ? 'Impacto médio'
             : 'Impacto baixo';
    card.appendChild(dot);
  });
}

</script>
  
<script>
// SW: permitir desligar com ?nosw=1
const NOSW = new URLSearchParams(location.search).get('nosw') === '1';
if ('serviceWorker' in navigator) {
  if (NOSW) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  } else {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
}
</script>
</body>
</html>
