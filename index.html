<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Diário — Cripto & Finanças EUA</title>
  <meta name="description" content="Resumo diário automático de notícias de cripto e finanças dos EUA." />
  <style>
    :root {
  --bg: #f8f7f5;
  --card: #ffffff;
  --text: #1f1f1f;
  --muted: #7a7268;
  --border: #e7e3dc;
  --accent: #222;      /* preto suave como acento */
}
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    header { position: sticky; top: 0; backdrop-filter: saturate(180%) blur(6px);
      background: rgba(255,255,255,0.9); border-bottom: 1px solid var(--border);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 12px 16px; }
    h1 { font-size: 18px; margin: 0; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn, .input, select, textarea {
      border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; background: #fff; color: var(--text);
      font-size: 14px;
    }
    .btn { cursor: pointer; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    main { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 16px; }
    @media (min-width: 980px) { main { grid-template-columns: 2fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px; }
    .news-card { transition: box-shadow .2s ease; }
    .news-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .pill { display: inline-block; padding: 2px 8px; border:1px solid var(--border); border-radius: 999px; font-size: 12px; color: #333; background: #fafafa; }
    .muted { color: var(--muted); }
    .grid { display: grid; gap: 8px; }
    .numbers { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
    @media (min-width: 540px) { .numbers { grid-template-columns: repeat(4, minmax(0,1fr)); } }
    .num { border:1px solid var(--border); background:#fafafa; border-radius: 12px; padding: 8px; }
    .num .k { font-size: 12px; color: var(--muted); }
    .num .v { font-weight: 700; }
    footer { text-align:center; color:#888; font-size:12px; padding: 24px 0; }
    .hidden { display: none !important; }
    .flex { display:flex; align-items:center; gap:8px; }
    .spacer { flex: 1; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { border:1px solid var(--border); padding:4px 10px; border-radius:999px; background:#fff; cursor:pointer; font-size:13px; }
    .chip.active { background:#111; color:#fff; border-color:#111; }
    .textarea { width: 100%; min-height: 180px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
    .empty { border: 1px dashed var(--border); padding: 16px; color: var(--muted); border-radius: 12px; background:#fff; }
    a { color: #0b57d0; text-decoration: underline; }
    .badge-ok { color: #0a7b00; font-weight:600; }
    .badge-fail { color: #b00020; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <h1>Painel Diário — Cripto &amp; Finanças EUA</h1>
        <div class="spacer"></div>
        <div id="feedStatus" class="muted">Feed: <span id="feedUrlLabel">./noticias.json</span> — <span id="statusLabel">a carregar…</span></div>
      </div>
      <div class="toolbar">
        <div class="flex">
          <span class="muted">Data:</span>
          <select id="dateSelect"></select>
        </div>
        <div class="chips" id="catChips"></div>
        <div class="flex">
          <input class="input" id="searchInput" placeholder="Pesquisar título, fonte, tags…" />
          <button class="btn" id="clearSearch">Limpar</button>
        </div>
        <div class="spacer"></div>
        <label class="btn">
          Importar JSON
          <input id="fileInput" type="file" accept="application/json" class="hidden" />
        </label>
        <button class="btn" id="pasteBtn">Colar JSON</button>
        <button class="btn" id="refreshBtn" title="Recarregar do feed agora">Recarregar</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="newsList" class="grid"></section>
    <aside>
      <div class="card">
        <h3>Hoje: 3 pontos de atenção</h3>
        <ol id="attentionList"></ol>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Como funciona o feed automático</strong>
        <p class="muted">
  O painel lê o ficheiro <code>noticias.json</code> desta pasta. Eu Agente IA atualizo esse ficheiro todos os dias às 09:40
  e o site recarrega os dados automaticamente (ou clica em “Recarregar”). Não precisa de instalar nada.
</p>
      </div>
      <div class="card" style="margin-top:12px">
        <details>
          <summary><strong>Formato do JSON</strong></summary>
<pre style="white-space:pre-wrap">
{
  "generated_at": "2025-10-20T09:40:00+01:00",
  "timezone": "Europe/Lisbon",
  "days": [{
    "date": "2025-10-20",
    "attention_points": ["BTC &gt; 110k", "Resultados banca EUA", "Falas do Fed"],
    "items": [{
      "id": "btc-1",
      "time": "09:10",
      "category": "Crypto",
      "title": "BTC recupera após queda",
      "summary": "Recuperação na sessão Ásia/Europa.",
      "source": "CoinDesk",
      "url": "https://example.com",
      "tags": ["BTC", "Altcoins"],
      "numbers": {"btc": 110500, "eth": 4000}
    }]
  }]
}
</pre>
        </details>
      </div>
    </aside>
  </main>

  <footer>Feed automático (./noticias.json). Atualiza a cada 5 minutos ou clica “Recarregar”.</footer>

  <!-- Modal -->
  <div id="modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:grid;place-items:center;padding:16px;">
    <div class="card" style="max-width:800px;width:100%;position:relative;">
      <button id="closeModal" class="btn" style="position:absolute;top:10px;right:10px;">Fechar</button>
      <h3>Colar JSON</h3>
      <p class="muted">Cole aqui o JSON no formato indicado.</p>
      <textarea id="pasteArea" class="textarea" placeholder='{"generated_at":"...","days":[...]}'></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button id="loadPaste" class="btn primary">Carregar</button>
      </div>
    </div>
  </div>

  <script>
  // ===== Settings =====
  // Por omissão, carrega ./noticias.json (mesma pasta). Para usar um URL remoto, defina FEED_URL abaixo.
  const FEED_URL = (new URLSearchParams(location.search).get('feed') || '').trim() || './noticias.json';
  const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutos

  // ===== Data state =====
  let DATA = { generated_at: null, timezone: "Europe/Lisbon", days: [] };
  const CATEGORIES = ["All", "Crypto", "US Macro", "Regulation", "Earnings", "Markets"];

  // ===== DOM refs =====
  const dateSelect = document.getElementById('dateSelect');
  const catChips = document.getElementById('catChips');
  const searchInput = document.getElementById('searchInput');
  const clearSearch = document.getElementById('clearSearch');
  const newsList = document.getElementById('newsList');
  const attentionList = document.getElementById('attentionList');
  const fileInput = document.getElementById('fileInput');
  const pasteBtn = document.getElementById('pasteBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const modal = document.getElementById('modal');
  const closeModal = document.getElementById('closeModal');
  const pasteArea = document.getElementById('pasteArea');
  const loadPaste = document.getElementById('loadPaste');
  const statusLabel = document.getElementById('statusLabel');
  const feedUrlLabel = document.getElementById('feedUrlLabel');

  // ===== UI State =====
  let currentDate = "";
  let currentCategory = "All";
  let currentQuery = "";

  feedUrlLabel.textContent = FEED_URL;

  async function fetchFeed() {
    statusLabel.textContent = "a carregar…";
    try {
      const nocache = FEED_URL + (FEED_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const res = await fetch(nocache, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      setData(json);
      statusLabel.innerHTML = '<span class="badge-ok">OK</span>';
    } catch (err) {
      statusLabel.innerHTML = '<span class="badge-fail">falhou</span>';
      console.error('Falha a obter feed:', err);
    }
  }

  function setData(json) {
    DATA = json || { days: [] };
    renderDateOptions();
    if (DATA.days && DATA.days.length) {
      currentDate = DATA.days[0].date;
    }
    renderAll();
  }

  function renderDateOptions() {
    dateSelect.innerHTML = "";
    if (!DATA.days || !DATA.days.length) {
      dateSelect.innerHTML = "<option>— sem dados —</option>";
      return;
    }
    DATA.days.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.date;
      opt.textContent = d.date;
      dateSelect.appendChild(opt);
    });
    dateSelect.value = currentDate || DATA.days[0].date;
  }

  function getCurrentDay() {
    return (DATA.days || []).find(d => d.date === currentDate);
  }

  function renderChips() {
    catChips.innerHTML = "";
    CATEGORIES.forEach(cat => {
      const b = document.createElement('button');
      b.className = 'chip' + (currentCategory === cat ? ' active' : '');
      b.textContent = cat === "All" ? "Todas" : (cat === "Regulation" ? "Regulação" : cat);
      b.onclick = () => { currentCategory = cat; renderAll(); };
      catChips.appendChild(b);
    });
  }

  function renderNews() {
    const day = getCurrentDay();
    newsList.innerHTML = "";
    attentionList.innerHTML = "";

    if (!day) {
      const div = document.createElement('div');
      div.className = 'empty';
      div.textContent = 'Sem dados do feed. Verifique o ficheiro noticias.json ou use Importar/Colar JSON.';
      newsList.appendChild(div);
      return;
    }

    (day.attention_points || []).slice(0,3).forEach(p => {
      const li = document.createElement('li'); li.textContent = p; attentionList.appendChild(li);
    });
    if (!day.attention_points || day.attention_points.length === 0) {
      const li = document.createElement('li'); li.textContent = "Sem prioridades definidas para esta data."; attentionList.appendChild(li);
    }

    let items = (day.items || []).slice().sort((a,b) => (a.time||"").localeCompare(b.time||""));
    if (currentCategory !== "All") items = items.filter(it => it.category === currentCategory);
    if (currentQuery.trim()) {
      const q = currentQuery.toLowerCase();
      items = items.filter(it =>
        (it.title||"").toLowerCase().includes(q) ||
        (it.summary||"").toLowerCase().includes(q) ||
        (it.source||"").toLowerCase().includes(q) ||
        (it.tags||[]).some(t => (t||"").toLowerCase().includes(q))
      );
    }

    if (!items.length) {
      const div = document.createElement('div');
      div.className = 'empty';
      div.textContent = 'Sem resultados para os filtros aplicados.';
      newsList.appendChild(div);
      return;
    }

    items.forEach(it => {
      const art = document.createElement('article'); art.className = 'card news-card';
      const top = document.createElement('div'); top.className = 'flex';
      const time = document.createElement('div'); time.className = 'muted'; time.textContent = it.time || "—";
      const cat = document.createElement('span'); cat.className = 'pill'; cat.textContent = it.category || "—";
      top.appendChild(time); top.appendChild(cat);
      const h3 = document.createElement('h3'); h3.style.margin = '8px 0 4px'; h3.style.fontSize = '18px'; h3.style.lineHeight = '1.2'; h3.textContent = it.title || "(sem título)";
      const sum = document.createElement('p'); sum.className = 'muted'; sum.textContent = it.summary || "";
      const meta = document.createElement('div'); meta.className = 'flex';
      if (it.source) { const s = document.createElement('span'); s.className = 'muted'; s.textContent = it.source; meta.appendChild(s); }
      if (it.url) { const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel = 'noreferrer'; a.textContent = 'Abrir fonte'; meta.appendChild(a); }
      if (it.tags && it.tags.length) {
        const tagsWrap = document.createElement('div'); tagsWrap.className = 'chips';
        it.tags.forEach(t => { const tag = document.createElement('span'); tag.className = 'pill'; tag.textContent = t; tagsWrap.appendChild(tag); });
        meta.appendChild(tagsWrap);
      }
      art.appendChild(top); art.appendChild(h3); if (it.summary) art.appendChild(sum); art.appendChild(meta);
      if (it.numbers) {
        const nums = document.createElement('div'); nums.className = 'numbers';
        for (const [k, v] of Object.entries(it.numbers)) {
          const box = document.createElement('div'); box.className = 'num';
          const kk = document.createElement('div'); kk.className = 'k'; kk.textContent = k.toUpperCase();
          const vv = document.createElement('div'); vv.className = 'v'; vv.textContent = typeof v === 'number' ? v.toLocaleString('pt-PT') : String(v);
          box.appendChild(kk); box.appendChild(vv); nums.appendChild(box);
        }
        art.appendChild(nums);
      }
      newsList.appendChild(art);
    });
  }

  function renderAll() { renderChips(); renderNews(); }

  // ===== Events =====
  dateSelect.addEventListener('change', e => { currentDate = e.target.value; renderAll(); });
  searchInput.addEventListener('input', e => { currentQuery = e.target.value || ""; renderAll(); });
  clearSearch.addEventListener('click', () => { currentQuery = ""; searchInput.value = ""; renderAll(); });
  pasteBtn.addEventListener('click', () => { modal.classList.remove('hidden'); pasteArea.value = ""; });
  document.getElementById('closeModal').addEventListener('click', () => { modal.classList.add('hidden'); });
  document.getElementById('loadPaste').addEventListener('click', () => {
    try { const json = JSON.parse(pasteArea.value); setData(json); modal.classList.add('hidden'); }
    catch (err) { alert("JSON inválido: " + err.message); }
  });
  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0]; if (!file) return;
    const text = await file.text();
    try { const json = JSON.parse(text); setData(json); }
    catch (err) { alert("Ficheiro JSON inválido: " + err.message); }
    e.target.value = "";
  });
  refreshBtn.addEventListener('click', fetchFeed);

  // ===== Kickoff =====
  fetchFeed(); // carrega no arranque
  setInterval(fetchFeed, AUTO_REFRESH_MS); // auto refresh 5 min
  </script>
</body>
</html>
