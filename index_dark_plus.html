<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel — Cripto & Finanças (Dark+)</title>
  <meta name="description" content="Painel escuro com filtro por 24/48/7 dias, tempo decorrido, lido/não lido e contadores." />
  <style>
    :root{
      --bg:#0f1117; --card:#161b22; --card-2:#1b212b;
      --text:#e6e9ef; --muted:#9aa4b2; --border:#2a3240;
      --accent:#4f7cff;
      --cat-crypto:#0ea5e9;      /* ciano */
      --cat-macro:#f59e0b;       /* âmbar */
      --cat-reg:#a78bfa;         /* roxo */
      --cat-earn:#34d399;        /* verde */
      --cat-mkt:#f472b6;         /* rosa */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent);text-decoration:underline}
    header{position:sticky;top:0;backdrop-filter:saturate(180%) blur(6px);
      background:rgba(15,17,23,.85);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1100px;margin:0 auto;padding:12px 16px}
    h1{font-size:18px;margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn,.input,select,textarea{border:1px solid var(--border);border-radius:12px;
      padding:8px 12px;background:var(--card-2);color:var(--text);font-size:14px}
    .btn{cursor:pointer;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    main{display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
    @media(min-width:980px){main{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .news-card{transition:box-shadow .2s ease,transform .06s ease,opacity .2s ease}
    .news-card:hover{box-shadow:0 10px 30px rgba(0,0,0,.25);transform:translateY(-1px)}
    .news-card.read{opacity:.55}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);
      border-radius:999px;font-size:12px;color:var(--text);background:#1d2330}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:10px}
    .numbers{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media(min-width:540px){.numbers{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .num{border:1px solid var(--border);background:#121722;border-radius:12px;padding:8px}
    .num .k{font-size:12px;color:var(--muted)} .num .v{font-weight:700}
    footer{text-align:center;color:var(--muted);font-size:12px;padding:24px 0}
    .hidden{display:none!important} .flex{display:flex;align-items:center;gap:8px}
    .spacer{flex:1} .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);padding:4px 10px;border-radius:999px;
      background:#141923;cursor:pointer;font-size:13px;color:var(--text)}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .counter{font-size:12px;color:var(--muted)}
    .switch{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .switch button{padding:6px 10px;background:#141923;color:var(--text);border:0}
    .switch button.active{background:var(--accent);color:#fff}
    .badge{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid var(--border);margin-left:6px}
    .badge.crypto{background:rgba(14,165,233,.12);border-color:rgba(14,165,233,.3);color:#8ddcff}
    .badge.macro{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.3);color:#ffd38a}
    .badge.reg{background:rgba(167,139,250,.12);border-color:rgba(167,139,250,.3);color:#d9c5ff}
    .badge.earn{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.3);color:#a9f7d6}
    .badge.mkt{background:rgba(244,114,182,.12);border-color:rgba(244,114,182,.3);color:#ffc7e7}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <h1>Painel — Cripto &amp; Finanças</h1>
        <div class="spacer"></div>
        <div class="counter">Feed: <span id="feedUrlLabel">./noticias.json</span> — <span id="statusLabel">a carregar…</span></div>
      </div>
      <div class="toolbar">
        <div class="switch" id="rangeSwitch">
          <button data-range="24" class="active">24h</button>
          <button data-range="48">48h</button>
          <button data-range="168">7d</button>
        </div>
        <div class="chips" id="catChips"></div>
        <div class="flex">
          <input class="input" id="searchInput" placeholder="Pesquisar título, fonte, tags…"/>
          <button class="btn" id="clearSearch">Limpar</button>
        </div>
        <label class="chip"><input type="checkbox" id="hideRead" style="margin-right:6px;"> Esconder lidas</label>
        <div class="spacer"></div>
        <div class="counter"><span id="countLabel">0</span> itens</div>
        <button class="btn" id="refreshBtn">Recarregar</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="newsList" class="grid"></section>
    <aside>
      <div class="card">
        <h3>Hoje: 3 pontos de atenção</h3>
        <ol id="attentionList"></ol>
      </div>
    </aside>
  </main>

  <footer>Modo escuro • Filtros persistentes • Marca como lida • Últimas 24/48/7 dias • Auto-refresh 5min.</footer>

  <script>
    const FEED_URL = (new URLSearchParams(location.search).get('feed') || '').trim() || './noticias.json';
    const AUTO_REFRESH_MS = 5 * 60 * 1000;

    let DATA = { generated_at:null, timezone:'Europe/Lisbon', days:[] };
    const CATEGORIES = ['All','Crypto','US Macro','Regulation','Earnings','Markets'];

    const newsList=document.getElementById('newsList');
    const attentionList=document.getElementById('attentionList');
    const statusLabel=document.getElementById('statusLabel');
    const feedUrlLabel=document.getElementById('feedUrlLabel');
    const searchInput=document.getElementById('searchInput');
    const clearSearch=document.getElementById('clearSearch');
    const refreshBtn=document.getElementById('refreshBtn');
    const countLabel=document.getElementById('countLabel');
    const hideRead=document.getElementById('hideRead');
    const rangeSwitch=document.getElementById('rangeSwitch');
    const catChips=document.getElementById('catChips');

    let currentQuery = localStorage.getItem('pn_query') || '';
    let currentCategory = localStorage.getItem('pn_cat') || 'All';
    let hoursRange = parseInt(localStorage.getItem('pn_range')||'24',10);
    const readSet = new Set(JSON.parse(localStorage.getItem('pn_read')||'[]'));

    feedUrlLabel.textContent = FEED_URL;
    searchInput.value = currentQuery;
    Array.from(rangeSwitch.querySelectorAll('button')).forEach(b=>{
      b.classList.toggle('active', parseInt(b.dataset.range,10)===hoursRange);
    });

    async function fetchFeed(){
      statusLabel.textContent='a carregar…';
      try{
        const nocache = FEED_URL + (FEED_URL.includes('?')?'&':'?') + '_ts=' + Date.now();
        const res = await fetch(nocache,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        DATA = json || {days:[]};
        renderAll();
        statusLabel.textContent='OK';
      }catch(e){
        statusLabel.textContent='falhou';
        console.error(e);
      }
    }

    function toTs(dayDate, timeStr){
      if(!dayDate) return 0;
      const [y,m,d] = dayDate.split('-').map(Number);
      let hh=0,mm=0;
      if(timeStr && timeStr.includes(':')){ const [h,mi]=timeStr.split(':'); hh=parseInt(h||'0',10); mm=parseInt(mi||'0',10); }
      return new Date(y,(m-1),d,hh,mm,0,0).getTime();
    }
    function timeAgo(ts){
      const diff = Date.now()-ts;
      const m = Math.floor(diff/60000), h = Math.floor(m/60), d = Math.floor(h/24);
      if (d>0) return d+'d';
      if (h>0) return h+'h';
      return (m||1)+'m';
    }
    function categoryBadge(cat){
      let cls='',label=cat||'—';
      if(cat==='Crypto') cls='crypto';
      else if(cat==='US Macro') {cls='macro'; label='US Macro';}
      else if(cat==='Regulation') {cls='reg'; label='Regulação';}
      else if(cat==='Earnings') cls='earn';
      else if(cat==='Markets') cls='mkt';
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function flattenWithin(hours){
      const items=[];
      (DATA.days||[]).forEach(day => (day.items||[]).forEach(it => {
        const _ts = toTs(day.date,it.time);
        items.push({day:day.date,_ts,_id: (it.id || (day.date+'-'+(it.title||'').slice(0,20))), ...it});
      }));
      if(!items.length) return [];
      const newest = Math.max(...items.map(i=>i._ts||0), Date.now());
      const cutoff = newest - hours*60*60*1000;
      let out = items.filter(i => (i._ts||0)>=cutoff);
      if(currentCategory!=='All') out = out.filter(i => i.category===currentCategory);
      if(currentQuery.trim()){
        const q = currentQuery.toLowerCase();
        out = out.filter(i =>
          (i.title||'').toLowerCase().includes(q) ||
          (i.summary||'').toLowerCase().includes(q) ||
          (i.source||'').toLowerCase().includes(q) ||
          (i.tags||[]).some(t => (t||'').toLowerCase().includes(q))
        );
      }
      out.sort((a,b)=>(b._ts||0)-(a._ts||0));
      return out;
    }

    function renderChips(){
      catChips.innerHTML='';
      CATEGORIES.forEach(cat=>{
        const b=document.createElement('button');
        b.className='chip'+(currentCategory===cat?' active':'');
        b.textContent=(cat==='All'?'Todas':(cat==='Regulation'?'Regulação':cat));
        b.onclick=()=>{
          currentCategory=cat;
          localStorage.setItem('pn_cat',currentCategory);
          renderList();
          renderCount();
          renderChips();
        };
        catChips.appendChild(b);
      });
    }

    function renderList(){
      newsList.innerHTML='';
      const items = flattenWithin(hoursRange);
      if (hideRead.checked){
        items.splice(0, items.length, ...items.filter(i=>!readSet.has(i._id)));
      }
      if(!items.length){
        const div=document.createElement('div');
        div.className='card';
        div.textContent='Sem notícias no intervalo selecionado.';
        newsList.appendChild(div);
        return;
      }
      items.forEach(it=>{
        const card=document.createElement('article');
        card.className='card news-card'+(readSet.has(it._id)?' read':'');
        const hh = new Date(it._ts).toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
        const dd = new Date(it._ts).toLocaleDateString('pt-PT',{year:'numeric',month:'2-digit',day:'2-digit'});
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center;">
            <div class="muted">${hh} • ${dd} <span class="muted" style="margin-left:8px;">(${timeAgo(it._ts)} atrás)</span></div>
            ${categoryBadge(it.category)}
          </div>
          <h3 style="margin:8px 0 4px;font-size:18px;line-height:1.2;">${it.title||'(sem título)'}</h3>
          ${it.summary?`<p class="muted">${it.summary}</p>`:''}
          <div class="flex" style="justify-content:space-between;align-items:center;margin-top:6px;">
            <div class="flex">
              ${it.source?`<span class="muted">${it.source}</span>`:''}
              ${it.url?`<a href="${it.url}" target="_blank" rel="noreferrer" style="margin-left:10px;">Abrir fonte</a>`:''}
            </div>
            <label class="chip" style="cursor:pointer;">
              <input type="checkbox" ${readSet.has(it._id)?'checked':''} data-id="${it._id}" class="markRead" style="margin-right:6px;"> Lida
            </label>
          </div>
        `;
        if(it.numbers){
          const nums=document.createElement('div'); nums.className='numbers';
          for(const [k,v] of Object.entries(it.numbers)){
            const box=document.createElement('div'); box.className='num';
            box.innerHTML=`<div class="k">${k.toUpperCase()}</div><div class="v">${typeof v==='number'?v.toLocaleString('pt-PT'):String(v)}</div>`;
            nums.appendChild(box);
          }
          card.appendChild(nums);
        }
        newsList.appendChild(card);
      });

      // Bind checkboxes
      newsList.querySelectorAll('.markRead').forEach(cb=>{
        cb.addEventListener('change',e=>{
          const id=e.target.getAttribute('data-id');
          if(e.target.checked){ readSet.add(id); } else { readSet.delete(id); }
          localStorage.setItem('pn_read', JSON.stringify(Array.from(readSet)));
          renderList(); // re-render para aplicar opacidade e filtro
          renderCount();
        });
      });

      // Attention from newest day
      attentionList.innerHTML='';
      const recentDay=(DATA.days||[])[0];
      if(recentDay && recentDay.attention_points){
        recentDay.attention_points.slice(0,3).forEach(p=>{
          const li=document.createElement('li'); li.textContent=p; attentionList.appendChild(li);
        });
      } else {
        const li=document.createElement('li'); li.textContent='Sem prioridades definidas.'; attentionList.appendChild(li);
      }
    }

    function renderCount(){
      const items = flattenWithin(hoursRange);
      const visible = hideRead.checked ? items.filter(i=>!readSet.has(i._id)) : items;
      countLabel.textContent = visible.length;
    }

    function renderAll(){
      renderChips();
      renderList();
      renderCount();
    }

    // Events
    refreshBtn.addEventListener('click', fetchFeed);
    clearSearch.addEventListener('click', ()=>{
      currentQuery=''; searchInput.value=''; localStorage.setItem('pn_query',''); renderList(); renderCount();
    });
    searchInput.addEventListener('input', e=>{
      currentQuery=e.target.value||''; localStorage.setItem('pn_query',currentQuery); renderList(); renderCount();
    });
    hideRead.addEventListener('change', ()=>{ renderList(); renderCount(); });
    rangeSwitch.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        hoursRange=parseInt(b.dataset.range,10);
        localStorage.setItem('pn_range', String(hoursRange));
        rangeSwitch.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        renderList(); renderCount();
      });
    });

    // Start
    fetchFeed();
    setInterval(fetchFeed, AUTO_REFRESH_MS);
  </script>
</body>
</html>
