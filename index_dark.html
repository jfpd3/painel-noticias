<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Diário — Cripto & Finanças EUA (Dark)</title>
  <meta name="description" content="Resumo de notícias de cripto e finanças dos EUA, com modo Últimas 24h." />
  <style>
    :root {
      /* Tema escuro premium */
      --bg: #0f1117;
      --card: #161b22;
      --card-2: #1b212b;
      --text: #e6e9ef;
      --muted: #9aa4b2;
      --border: #2a3240;
      --accent: #4f7cff;     /* azul realce */
      --accent-2: #a78bfa;   /* roxo suave */
      --success: #2ecc71;
      --warning: #f39c12;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a { color: var(--accent); text-decoration: underline; }
    header { position: sticky; top: 0; backdrop-filter: saturate(180%) blur(6px);
      background: rgba(15,17,23,0.8); border-bottom: 1px solid var(--border); z-index: 10;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 12px 16px; }
    h1 { font-size: 18px; margin: 0; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn, .input, select, textarea {
      border: 1px solid var(--border); border-radius: 12px; padding: 8px 12px; background: var(--card-2); color: var(--text);
      font-size: 14px;
    }
    .btn { cursor: pointer; transition: transform .05s ease; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn.ghost { background: transparent; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    main { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 16px; }
    @media (min-width: 980px) { main { grid-template-columns: 2fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 14px; }
    .news-card { transition: box-shadow .2s ease, transform .06s ease; }
    .news-card:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.25); transform: translateY(-1px); }
    .pill { display: inline-block; padding: 2px 8px; border:1px solid var(--border); border-radius: 999px; font-size: 12px; color: var(--text); background: #1d2330; }
    .muted { color: var(--muted); }
    .grid { display: grid; gap: 10px; }
    .numbers { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
    @media (min-width: 540px) { .numbers { grid-template-columns: repeat(4, minmax(0,1fr)); } }
    .num { border:1px solid var(--border); background:#121722; border-radius: 12px; padding: 8px; }
    .num .k { font-size: 12px; color: var(--muted); }
    .num .v { font-weight: 700; }
    footer { text-align:center; color:var(--muted); font-size:12px; padding: 24px 0; }
    .hidden { display: none !important; }
    .flex { display:flex; align-items:center; gap:8px; }
    .spacer { flex: 1; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { border:1px solid var(--border); padding:4px 10px; border-radius:999px; background:#141923; cursor:pointer; font-size:13px; color: var(--text); }
    .chip.active { background: var(--accent); color:#fff; border-color: var(--accent); }
    .mode-tabs { display:flex; gap:8px; }
    .mode-btn { padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#141923; color:var(--text); cursor:pointer; }
    .mode-btn.active { background: var(--accent-2); border-color: var(--accent-2); color:#0b0f17; font-weight:600; }
    .status-ok { color: var(--success); font-weight:600; }
    .status-fail { color: #ff6b6b; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <h1>Painel Diário — Cripto &amp; Finanças EUA</h1>
        <div class="spacer"></div>
        <div id="feedStatus" class="muted">Feed: <span id="feedUrlLabel">./noticias.json</span> — <span id="statusLabel">a carregar…</span></div>
      </div>
      <div class="toolbar">
        <div class="mode-tabs">
          <button class="mode-btn active" id="mode24h">Últimas 24h</button>
          <button class="mode-btn" id="modeDate">Por data</button>
        </div>
        <div class="flex" id="dateWrap" style="display:none">
          <span class="muted">Data:</span>
          <select id="dateSelect"></select>
        </div>
        <div class="chips" id="catChips"></div>
        <div class="flex">
          <input class="input" id="searchInput" placeholder="Pesquisar título, fonte, tags…" />
          <button class="btn" id="clearSearch">Limpar</button>
        </div>
        <div class="spacer"></div>
        <button class="btn" id="refreshBtn" title="Recarregar do feed agora">Recarregar</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="newsList" class="grid"></section>
    <aside>
      <div class="card">
        <h3>Hoje: 3 pontos de atenção</h3>
        <ol id="attentionList"></ol>
      </div>
    </aside>
  </main>

  <footer>Feed automático (./noticias.json). Atualiza a cada 5 minutos • Modo <strong>Últimas 24h</strong> por defeito.</footer>

  <script>
  // ===== Settings =====
  const FEED_URL = (new URLSearchParams(location.search).get('feed') || '').trim() || './noticias.json';
  const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutos
  const TZ = "Europe/Lisbon";

  // ===== Data state =====
  let DATA = { generated_at: null, timezone: TZ, days: [] };
  const CATEGORIES = ["All", "Crypto", "US Macro", "Regulation", "Earnings", "Markets"];

  // ===== DOM refs =====
  const dateSelect = document.getElementById('dateSelect');
  const dateWrap = document.getElementById('dateWrap');
  const catChips = document.getElementById('catChips');
  const searchInput = document.getElementById('searchInput');
  const clearSearch = document.getElementById('clearSearch');
  const newsList = document.getElementById('newsList');
  const attentionList = document.getElementById('attentionList');
  const refreshBtn = document.getElementById('refreshBtn');
  const statusLabel = document.getElementById('statusLabel');
  const feedUrlLabel = document.getElementById('feedUrlLabel');
  const mode24hBtn = document.getElementById('mode24h');
  const modeDateBtn = document.getElementById('modeDate');

  // ===== UI State =====
  let currentDate = "";
  let currentCategory = "All";
  let currentQuery = "";
  let mode = "24h"; // '24h' | 'date'

  feedUrlLabel.textContent = FEED_URL;

  async function fetchFeed() {
    statusLabel.textContent = "a carregar…";
    try {
      const nocache = FEED_URL + (FEED_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const res = await fetch(nocache, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      setData(json);
      statusLabel.innerHTML = '<span class="status-ok">OK</span>';
    } catch (err) {
      statusLabel.innerHTML = '<span class="status-fail">falhou</span>';
      console.error('Falha a obter feed:', err);
    }
  }

  function setData(json) {
    DATA = json || { days: [] };
    renderDateOptions();
    if (DATA.days && DATA.days.length) {
      currentDate = DATA.days[0].date;
    }
    renderAll();
  }

  function renderDateOptions() {
    dateSelect.innerHTML = "";
    if (!DATA.days || !DATA.days.length) {
      dateSelect.innerHTML = "<option>— sem dados —</option>";
      return;
    }
    DATA.days.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.date;
      opt.textContent = d.date;
      dateSelect.appendChild(opt);
    });
    dateSelect.value = currentDate || DATA.days[0].date;
  }

  function toTimestamp(dayDate, timeStr) {
    if (!dayDate) return null;
    const [y,m,d] = dayDate.split('-').map(Number);
    let hh=0, mm=0;
    if (timeStr && timeStr.includes(':')) {
      const parts = timeStr.split(':');
      hh = parseInt(parts[0]||'0',10); mm = parseInt(parts[1]||'0',10);
    }
    const dt = new Date(y, (m-1), d, hh, mm, 0, 0);
    return dt.getTime();
  }

  function flattenItemsWithin24h() {
    const items = [];
    (DATA.days || []).forEach(day => {
      (day.items || []).forEach(it => {
        const ts = toTimestamp(day.date, it.time);
        items.push({ day: day.date, ...it, _ts: ts });
      });
    });
    if (!items.length) return [];
    const newestTs = Math.max(...items.map(i => i._ts || 0), Date.now());
    const cutoff = newestTs - 24*60*60*1000;
    let within = items.filter(i => (i._ts || 0) >= cutoff);
    if (currentCategory !== "All") within = within.filter(i => i.category === currentCategory);
    if (currentQuery.trim()) {
      const q = currentQuery.toLowerCase();
      within = within.filter(it =>
        (it.title||"").toLowerCase().includes(q) ||
        (it.summary||"").toLowerCase().includes(q) ||
        (it.source||"").toLowerCase().includes(q) ||
        (it.tags||[]).some(t => (t||"").toLowerCase().includes(q))
      );
    }
    within.sort((a,b) => (b._ts||0) - (a._ts||0));
    return within;
  }

  function renderNews() {
    newsList.innerHTML = "";
    attentionList.innerHTML = "";

    if (mode === "24h") {
      const items = flattenItemsWithin24h();
      if (!items.length) {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = 'Sem notícias nas últimas 24 horas (ou feed vazio).';
        newsList.appendChild(div);
        return;
      }
      items.forEach(it => {
        const art = document.createElement('article'); art.className = 'card news-card';
        const top = document.createElement('div'); top.className = 'flex';
        const time = document.createElement('div'); time.className = 'muted';
        const dt = new Date(it._ts || Date.now());
        const hh = dt.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'});
        const dd = dt.toLocaleDateString('pt-PT', {year:'numeric', month:'2-digit', day:'2-digit'});
        time.textContent = `${hh}  •  ${dd}`;
        const cat = document.createElement('span'); cat.className = 'pill'; cat.textContent = it.category || "—";
        top.appendChild(time); top.appendChild(cat);
        const h3 = document.createElement('h3'); h3.style.margin = '8px 0 4px'; h3.style.fontSize = '18px'; h3.style.lineHeight = '1.2'; h3.textContent = it.title || "(sem título)";
        const sum = document.createElement('p'); sum.className = 'muted'; sum.textContent = it.summary || "";
        const meta = document.createElement('div'); meta.className = 'flex';
        if (it.source) { const s = document.createElement('span'); s.className = 'muted'; s.textContent = it.source; meta.appendChild(s); }
        if (it.url) { const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel = 'noreferrer'; a.textContent = 'Abrir fonte'; meta.appendChild(a); }
        if (it.tags && it.tags.length) {
          const tagsWrap = document.createElement('div'); tagsWrap.className = 'chips';
          it.tags.forEach(t => { const tag = document.createElement('span'); tag.className = 'pill'; tag.textContent = t; tagsWrap.appendChild(tag); });
          meta.appendChild(tagsWrap);
        }
        art.appendChild(top); art.appendChild(h3); if (it.summary) art.appendChild(sum); art.appendChild(meta);
        if (it.numbers) {
          const nums = document.createElement('div'); nums.className = 'numbers';
          for (const [k, v] of Object.entries(it.numbers)) {
            const box = document.createElement('div'); box.className = 'num';
            const kk = document.createElement('div'); kk.className = 'k'; kk.textContent = k.toUpperCase();
            const vv = document.createElement('div'); vv.className = 'v'; vv.textContent = typeof v === 'number' ? v.toLocaleString('pt-PT') : String(v);
            box.appendChild(kk); box.appendChild(vv); nums.appendChild(box);
          }
          art.appendChild(nums);
        }
        newsList.appendChild(art);
      });

      const recentDay = (DATA.days || [])[0];
      if (recentDay && recentDay.attention_points) {
        recentDay.attention_points.slice(0,3).forEach(p => {
          const li = document.createElement('li'); li.textContent = p; attentionList.appendChild(li);
        });
      } else {
        const li = document.createElement('li'); li.textContent = "Sem prioridades definidas."; attentionList.appendChild(li);
      }
      return;
    }

    const day = (DATA.days || []).find(d => d.date === currentDate);
    if (!day) {
      const div = document.createElement('div'); div.className = 'card'; div.textContent = 'Sem dados do feed para esta data.'; newsList.appendChild(div); return;
    }
    (day.attention_points || []).slice(0,3).forEach(p => { const li = document.createElement('li'); li.textContent = p; attentionList.appendChild(li); });
    if (!day.attention_points || day.attention_points.length === 0) { const li = document.createElement('li'); li.textContent = "Sem prioridades definidas para esta data."; attentionList.appendChild(li); }

    let items = (day.items || []).slice().sort((a,b) => (a.time||"").localeCompare(b.time||""));
    if (currentCategory !== "All") items = items.filter(it => it.category === currentCategory);
    if (currentQuery.trim()) {
      const q = currentQuery.toLowerCase();
      items = items.filter(it =>
        (it.title||"").toLowerCase().includes(q) ||
        (it.summary||"").toLowerCase().includes(q) ||
        (it.source||"").toLowerCase().includes(q) ||
        (it.tags||[]).some(t => (t||"").toLowerCase().includes(q))
      );
    }
    if (!items.length) {
      const div = document.createElement('div'); div.className = 'card'; div.textContent = 'Sem resultados para os filtros aplicados.'; newsList.appendChild(div); return;
    }
    items.forEach(it => {
      const art = document.createElement('article'); art.className = 'card news-card';
      const top = document.createElement('div'); top.className = 'flex';
      const time = document.createElement('div'); time.className = 'muted'; time.textContent = it.time || "—";
      const cat = document.createElement('span'); cat.className = 'pill'; cat.textContent = it.category || "—";
      top.appendChild(time); top.appendChild(cat);
      const h3 = document.createElement('h3'); h3.style.margin = '8px 0 4px'; h3.style.fontSize = '18px'; h3.style.lineHeight = '1.2'; h3.textContent = it.title || "(sem título)";
      const sum = document.createElement('p'); sum.className = 'muted'; sum.textContent = it.summary || "";
      const meta = document.createElement('div'); meta.className = 'flex';
      if (it.source) { const s = document.createElement('span'); s.className = 'muted'; s.textContent = it.source; meta.appendChild(s); }
      if (it.url) { const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel = 'noreferrer'; a.textContent = 'Abrir fonte'; meta.appendChild(a); }
      if (it.tags && it.tags.length) {
        const tagsWrap = document.createElement('div'); tagsWrap.className = 'chips';
        it.tags.forEach(t => { const tag = document.createElement('span'); tag.className = 'pill'; tag.textContent = t; tagsWrap.appendChild(tag); });
        meta.appendChild(tagsWrap);
      }
      art.appendChild(top); art.appendChild(h3); if (it.summary) art.appendChild(sum); art.appendChild(meta);
      newsList.appendChild(art);
    });
  }

  function renderChips() {
    catChips.innerHTML = "";
    CATEGORIES.forEach(cat => {
      const b = document.createElement('button');
      b.className = 'chip' + (currentCategory === cat ? ' active' : '');
      b.textContent = cat === "All" ? "Todas" : (cat === "Regulation" ? "Regulação" : cat);
      b.onclick = () => { currentCategory = cat; renderNews(); };
      catChips.appendChild(b);
    });
  }

  function renderAll() { renderChips(); renderNews(); }

  // ===== Events =====
  dateSelect.addEventListener('change', e => { currentDate = e.target.value; renderAll(); });
  searchInput.addEventListener('input', e => { currentQuery = e.target.value || ""; renderNews(); });
  clearSearch.addEventListener('click', () => { currentQuery = ""; searchInput.value = ""; renderNews(); });
  refreshBtn.addEventListener('click', fetchFeed);
  mode24hBtn.addEventListener('click', () => {
    mode = "24h"; mode24hBtn.classList.add('active'); modeDateBtn.classList.remove('active'); dateWrap.style.display = 'none'; renderNews();
  });
  modeDateBtn.addEventListener('click', () => {
    mode = "date"; modeDateBtn.classList.add('active'); mode24hBtn.classList.remove('active'); dateWrap.style.display = 'flex'; renderNews();
  });

  // ===== Kickoff =====
  fetchFeed(); // carrega no arranque
  setInterval(fetchFeed, AUTO_REFRESH_MS); // auto refresh 5 min
  </script>
</body>
</html>
